<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Slack Auth via Pipedream</title>
  </head>
  <body>
    <h1>Connect Your Slack Account via Pipedream</h1>
    <button id="connect-btn">Connect Slack Account</button>

    <script type="module">
      import { createFrontendClient } from "https://cdn.jsdelivr.net/npm/@pipedream/sdk/browser/+esm";

      const pd = createFrontendClient();

      document.getElementById("connect-btn").addEventListener("click", async () => {
        try {
          // Fetch a short-lived connect token from the backend.
          const response = await fetch("/token");
          const data = await response.json();
          const token = data.token;

          // The OAuth App ID is passed from the backend into the template.
          const oauthAppId = "{{ oauth_app_id }}";

          console.log("Token fetched:", token);

          // Initiate the connection using the Pipedream SDK.
          pd.connectAccount({
            app: "slack",
            token: token,
            onSuccess: ({ id: accountId }) => {
              console.log(`Slack account successfully connected: ${accountId}`);
              alert(`Slack account successfully connected: ${accountId}`);
              // Optionally, update your UI or redirect the user
            },
            onError: (error) => {
              console.error("Connection error:", error);
              alert("Error connecting Slack account: " + error);
            },
          });
        } catch (error) {
          console.error("Error fetching token:", error);
          alert("Error fetching token: " + error);
        }
      });
    </script>
  </body>
</html>

